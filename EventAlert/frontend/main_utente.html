<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Event Alert - Utente Page</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
    }

    .sidebar {
      width: 200px;
      background-color: #2c3e50;
      height: 100vh;
      color: white;
      padding-top: 20px;
    }

    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: white;
      text-decoration: none;
    }

    .sidebar a:hover {
      background-color: #34495e;
    }

    .content {
      padding: 20px;
      flex-grow: 1;
    }

    .event {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

  <!-- Sidebar utente -->
  <div class="sidebar">
    <a id="homepageLink" href="#">ğŸ  Homepage</a>
    <a id="ticketsLink"href="#">ğŸ« I tuoi biglietti</a>
    <a id="accountLink" href="#">ğŸ‘¤ Account</a>
  </div>

  <!-- Contenuto principale -->
  <div class="content">
    <h1>Event Alert - Utente Page</h1>
    <p id="welcomeText">Benvenuto utente!</p>
    <h3>I tuoi eventi consigliati</h3>
    <div id="eventiContainer">Caricamento eventi...</div>
  </div>

  <script>
    function getEmail() {
      const urlEmail = new URLSearchParams(window.location.search).get('email');
      if (urlEmail) {
        sessionStorage.setItem('email', urlEmail);
        return urlEmail;
      }
      return sessionStorage.getItem('email');
    }

    async function partecipaEvento(id_evento) {
      const email = getEmail();

      try {
        const response = await fetch("http://localhost:8080/partecipa_evento", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: email, id_evento: id_evento })
        });

        const result = await response.json();
        if (response.ok) {
          alert("Partecipazione registrata con successo!");
        } else {
          alert("Errore: " + (result.error || "impossibile registrare la partecipazione"));
        }
      } catch (err) {
        console.error("Errore partecipazione evento:", err);
        alert("Errore durante la partecipazione all'evento.");
      }
    }

    async function caricaEventi() {
      const email = getEmail();
      const container = document.getElementById("eventiContainer");
      const welcome = document.getElementById("welcomeText");
      const homepageLink = document.getElementById("homepageLink");
      const accountLink = document.getElementById("accountLink");
      const ticketsLink = document.getElementById("ticketsLink");

      if (!email) {
        container.innerHTML = "Errore: email non specificata nell'URL.";
        return;
      }

      welcome.innerText = 'Benvenuto utente!';

      
      homepageLink.href = `main_utente.html?email=${encodeURIComponent(email)}`;
      accountLink.href = `account.html?email=${encodeURIComponent(email)}`;
      ticketsLink.href = `tickets.html?email=${encodeURIComponent(email)}`;

      try {
        const now = new Date().toISOString().slice(0,19); // "YYYY-MM-DDTHH:MM:SS"
        const response = await fetch("http://localhost:8080/eventi_utente?email=" + encodeURIComponent(email) + "&now=" + encodeURIComponent(now));
        const result = await response.json();

        if (result.eventi && result.eventi.length > 0) {
          container.innerHTML = "";

          result.eventi.forEach(evento => {
            const div = document.createElement("div");
            div.className = "event";
            div.innerHTML = `
              <strong>Interesse:</strong> ${evento.interesse} <br>
              <strong>Data:</strong> ${evento.data_evento} <br>
              <strong>Ora:</strong> ${evento.ora_evento} <br>
              <strong>Luogo:</strong> ${evento.luogo_evento} <br>
              <strong>Origine:</strong> ${evento.origine} <br>
              <strong>Descrizione:</strong> ${evento.descrizione} <br>
              <button onclick="partecipaEvento('${evento.id_evento}')">âœ… Partecipa all'evento</button>
              <hr>
            `;
            container.appendChild(div);
          });
        } else {
          container.innerHTML = "<p>Nessun evento trovato.</p>";
        }

      } catch (error) {
        console.error("Errore nel caricamento eventi:", error);
        container.innerHTML = "Errore nel caricamento degli eventi.";
      }
    }

    caricaEventi();
  </script>
</body>
</html>