<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Account</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
    }
    .sidebar {
      width: 200px;
      background-color: #2c3e50;
      height: 100vh;
      color: white;
      padding-top: 20px;
    }
    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: white;
      text-decoration: none;
    }
    .sidebar a:hover {
      background-color: #34495e;
    }
    .content {
      padding: 20px;
      flex-grow: 1;
    }
    h2 {
      color: #2c3e50;
    }
    .field {
      margin-bottom: 12px;
    }
    .label {
      font-weight: bold;
    }
    .value {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  
  <div class="sidebar" id="sidebar"></div>

  <div class="content">
    <h2>Dati Account</h2>
    <div class="field"><span class="label">Nome:</span> <span class="value" id="nome"></span></div>
    <div class="field"><span class="label">Cognome:</span> <span class="value" id="cognome"></span></div>
    <div class="field"><span class="label">Email:</span> <span class="value" id="email"></span></div>
    <div class="field"><span class="label">Età:</span> <span class="value" id="eta"></span></div>
    <div class="field"><span class="label">Ruolo:</span> <span class="value" id="ruolo"></span></div>
    <div class="field">
      <span class="label">Interessi:</span>
      <span class="value" id="interessi"></span>
      <button id="editBtn">✏️ Modifica interessi</button>
    </div>

    <div id="editInteressi" style="display:none; margin-top:20px;">
      <h3>Modifica i tuoi interessi</h3>

      <label><input type="checkbox" class="macro" data-group="musica"> Musica</label><br>
      <div style="margin-left:20px;">
        <label><input type="checkbox" class="sottotopic musica" value="pop"> Pop</label><br>
        <label><input type="checkbox" class="sottotopic musica" value="jazz"> Jazz</label><br>
        <label><input type="checkbox" class="sottotopic musica" value="house"> House</label><br>
      </div>

      <label><input type="checkbox" class="macro" data-group="sport"> Sport</label><br>
      <div style="margin-left:20px;">
        <label><input type="checkbox" class="sottotopic sport" value="calcio"> Calcio</label><br>
        <label><input type="checkbox" class="sottotopic sport" value="tennis"> Tennis</label><br>
        <label><input type="checkbox" class="sottotopic sport" value="sport_acquatico"> Sport acquatico</label><br>
      </div>

      <label><input type="checkbox" class="macro" data-group="musei"> Musei</label><br>
      <div style="margin-left:20px;">
        <label><input type="checkbox" class="sottotopic musei" value="arte_contemporanea"> Arte contemporanea</label><br>
        <label><input type="checkbox" class="sottotopic musei" value="arte_classica"> Arte classica</label><br>
        <label><input type="checkbox" class="sottotopic musei" value="arte_moderna"> Arte moderna</label><br>
      </div>

      <label><input type="checkbox" class="macro" data-group="cibo"> Cibo</label><br>
      <div style="margin-left:20px;">
        <label><input type="checkbox" class="sottotopic cibo" value="italiano"> Italiano</label><br>
        <label><input type="checkbox" class="sottotopic cibo" value="asiatico"> Asiatico</label><br>
        <label><input type="checkbox" class="sottotopic cibo" value="fast_food"> Fast food</label><br>
      </div>

      <br>
      <button id="saveBtn">💾 Salva interessi</button>
      <p id="updateResponse" style="font-weight:bold;"></p>
    </div>
  </div>

  <script>
    let userInteressi = [];

    function getEmail() {
      const urlEmail = new URLSearchParams(window.location.search).get('email');
      if (urlEmail) {
        sessionStorage.setItem('email', urlEmail);
        return urlEmail;
      }
      return sessionStorage.getItem('email');
    }

    async function caricaAccount() {
      const email = getEmail();
      if (!email) return;

      try {
        const response = await fetch("http://localhost:8080/account?email=" + encodeURIComponent(email));
        const data = await response.json();

        if (data.error) {
          alert(data.error);
          return;
        }

        document.getElementById("nome").innerText = data.nome;
        document.getElementById("cognome").innerText = data.cognome;
        document.getElementById("email").innerText = data.email;
        document.getElementById("eta").innerText = data.eta;
        document.getElementById("ruolo").innerText = data.ruolo;
        document.getElementById("interessi").innerText = data.interessi.join(", ");

        userInteressi = data.interessi;

        const sidebar = document.getElementById("sidebar");
        if (data.ruolo === "admin") {
          sidebar.innerHTML = `
            <a href="main_admin.html?email=${encodeURIComponent(email)}">🏠 Homepage</a>
            <a href="create_event.html?email=${encodeURIComponent(email)}">📝 Crea il tuo evento</a>
            <a href="tickets.html?email=${encodeURIComponent(email)}">🎫 I tuoi biglietti</a>
            <a href="#">📅 I tuoi eventi</a>
            <a href="account.html?email=${encodeURIComponent(email)}">👤 Account</a>
          `;
        } else {
          sidebar.innerHTML = `
            <a href="main_utente.html?email=${encodeURIComponent(email)}">🏠 Homepage</a>
            <a href="tickets.html?email=${encodeURIComponent(email)}">🎫 I tuoi biglietti</a>
            <a href="account.html?email=${encodeURIComponent(email)}">👤 Account</a>
          `;
        }
      } catch (err) {
        console.error("Errore caricamento account:", err);
      }
    }

    document.getElementById("editBtn").addEventListener("click", () => {
      document.getElementById("editInteressi").style.display = "block";

      document.querySelectorAll(".sottotopic").forEach(cb => {
        cb.checked = userInteressi.includes(cb.value);
      });

      document.querySelectorAll(".macro").forEach(macro => {
        const group = macro.dataset.group;
        const sottotopics = document.querySelectorAll(".sottotopic." + group);
        macro.checked = Array.from(sottotopics).every(cb => cb.checked);
      });
    });

    document.querySelectorAll('.macro').forEach(macro => {
      macro.addEventListener('change', function () {
        const group = this.dataset.group;
        document.querySelectorAll('.sottotopic.' + group)
                .forEach(cb => cb.checked = this.checked);
      });
    });

    document.querySelectorAll('.sottotopic').forEach(st => {
      st.addEventListener('change', function () {
        const group = Array.from(this.classList).find(c => c !== "sottotopic");
        const all = document.querySelectorAll('.sottotopic.' + group);
        const checked = document.querySelectorAll('.sottotopic.' + group + ':checked');
        const macro = document.querySelector('.macro[data-group="' + group + '"]');
        macro.checked = all.length === checked.length;
      });
    });

    // Salva interessi aggiornati
    document.getElementById("saveBtn").addEventListener("click", async () => {
      const email = getEmail();
      const newInteressi = Array.from(document.querySelectorAll('.sottotopic:checked'))
                                .map(cb => cb.value);

      try {
        const response = await fetch("http://localhost:8080/update_interessi", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: email, interessi: newInteressi })
        });

        const result = await response.json();
        const box = document.getElementById("updateResponse");

        if (response.ok) {
            box.style.color = "green";
            box.innerText = result.message;
            userInteressi = newInteressi;
            document.getElementById("interessi").innerText = userInteressi.join(", ");

            setTimeout(() => {
                document.getElementById("editInteressi").style.display = "none";
                box.innerText = ""; 
            }, 500);
        } else {
            box.style.color = "red";
            box.innerText = result.error || "Errore durante l'aggiornamento";
            }
      } catch (err) {
        console.error("Errore update interessi:", err);
      }
    });

    caricaAccount();
  </script>
</body>
</html>